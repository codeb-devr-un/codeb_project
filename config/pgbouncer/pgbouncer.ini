;; =============================================================================
;; PgBouncer Configuration - Hyperscale Production
;; Target: 100,000 concurrent users
;; Connection Pooling Strategy: Transaction Mode
;; =============================================================================

[databases]
;; Primary database - Write operations
codeb_primary = host=${POSTGRES_HOST} port=5432 dbname=${POSTGRES_DB} auth_user=${POSTGRES_USER}

;; Read replicas - Read operations (load balanced)
codeb_read = host=${POSTGRES_READ_HOST} port=5432 dbname=${POSTGRES_DB} auth_user=${POSTGRES_USER}

;; Fallback to primary if replicas unavailable
* = host=${POSTGRES_HOST} port=5432 dbname=${POSTGRES_DB} auth_user=${POSTGRES_USER}

[pgbouncer]
;; =============================================================================
;; Connection Settings
;; =============================================================================

;; Listen on all interfaces
listen_addr = 0.0.0.0
listen_port = 6432

;; Authentication
auth_type = scram-sha-256
auth_file = /etc/pgbouncer/userlist.txt
auth_query = SELECT usename, passwd FROM pg_shadow WHERE usename=$1

;; =============================================================================
;; Pool Settings - Optimized for 100K Users
;; =============================================================================

;; Transaction pooling for maximum efficiency
pool_mode = transaction

;; Maximum client connections (100K users / 10 app instances = 10K per instance)
max_client_conn = 10000

;; Default pool size per database/user pair
default_pool_size = 50

;; Minimum pool size to keep ready
min_pool_size = 10

;; Reserve connections for superuser
reserve_pool_size = 5
reserve_pool_timeout = 3

;; Maximum connections per database
max_db_connections = 100

;; Maximum connections per user
max_user_connections = 100

;; =============================================================================
;; Timeout Settings
;; =============================================================================

;; Server connection timeout (seconds)
server_connect_timeout = 5

;; Server login timeout (seconds)
server_login_retry = 3

;; Query timeout - cancel if running too long (0 = disabled)
query_timeout = 30

;; Query wait timeout - how long clients wait for server connection
query_wait_timeout = 60

;; Client idle timeout - disconnect idle clients
client_idle_timeout = 300

;; Server idle timeout - disconnect idle server connections
server_idle_timeout = 600

;; =============================================================================
;; Connection Lifetime Settings
;; =============================================================================

;; Server lifetime - recycle connections periodically
server_lifetime = 3600

;; Server check delay - how often to check server health
server_check_delay = 30

;; Server check query - lightweight health check
server_check_query = SELECT 1

;; Reset query for cleaning up server state
server_reset_query = DISCARD ALL

;; Reset query for transaction mode (more efficient)
server_reset_query_always = 0

;; =============================================================================
;; Logging & Monitoring
;; =============================================================================

;; Log file location
logfile = /var/log/pgbouncer/pgbouncer.log

;; Log connections/disconnections
log_connections = 1
log_disconnections = 1

;; Log pooler errors
log_pooler_errors = 1

;; Statistics period (seconds)
stats_period = 60

;; Verbose logging for debugging (disable in production)
verbose = 0

;; =============================================================================
;; Admin & Stats
;; =============================================================================

;; Admin console access
admin_users = ${PGBOUNCER_ADMIN_USER}
stats_users = ${PGBOUNCER_STATS_USER}

;; Admin console database
;; Connect: psql -p 6432 -U admin pgbouncer
;; Commands: SHOW POOLS; SHOW STATS; SHOW SERVERS;

;; =============================================================================
;; Security Settings
;; =============================================================================

;; Ignore startup parameters that can't be tracked
ignore_startup_parameters = extra_float_digits,search_path,application_name

;; SSL settings (enable in production)
;; client_tls_sslmode = require
;; client_tls_key_file = /etc/pgbouncer/client.key
;; client_tls_cert_file = /etc/pgbouncer/client.crt
;; client_tls_ca_file = /etc/pgbouncer/ca.crt

;; server_tls_sslmode = require
;; server_tls_key_file = /etc/pgbouncer/server.key
;; server_tls_cert_file = /etc/pgbouncer/server.crt
;; server_tls_ca_file = /etc/pgbouncer/ca.crt

;; =============================================================================
;; TCP Settings for High Performance
;; =============================================================================

;; TCP keepalive (seconds)
tcp_keepalive = 1
tcp_keepcnt = 3
tcp_keepidle = 60
tcp_keepintvl = 10

;; TCP user timeout (Linux only)
tcp_user_timeout = 30

;; Socket directory (for local connections)
unix_socket_dir = /var/run/pgbouncer

;; =============================================================================
;; Application Name Tracking
;; =============================================================================

;; Track application names for monitoring
application_name_add_host = 1

;; =============================================================================
;; DNS Settings
;; =============================================================================

;; DNS lookup interval (seconds)
dns_max_ttl = 15
dns_zone_check_period = 30

;; =============================================================================
;; Process Settings
;; =============================================================================

;; Run as pgbouncer user
;; user = pgbouncer

;; PID file
pidfile = /var/run/pgbouncer/pgbouncer.pid

;; Maximum OS open files (should match ulimit)
;; max_packet_size = 2147483647

;; Disable TLS certificate checking for internal networks
;; server_tls_sslmode = prefer
