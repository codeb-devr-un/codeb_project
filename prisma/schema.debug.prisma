// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  admin
  member
}

enum ProjectStatus {
  planning
  design
  development
  testing
  completed
  pending
}

enum ProjectVisibility {
  public
  private
  client
}

enum ProjectPriority {
  low
  medium
  high
  urgent
}

enum TaskStatus {
  backlog
  todo
  in_progress
  review
  done
}

enum TaskPriority {
  low
  medium
  high
  urgent
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  HALF_DAY
  REMOTE
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ApprovalType {
  EXPENSE
  LEAVE
  PURCHASE
  GENERAL
}

enum ContractStatus {
  DRAFT
  ACTIVE
  COMPLETED
  TERMINATED
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

enum JoinRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

// Models

model Workspace {
  id     String  @id @default(uuid())
  name   String
  domain String? @unique // Optional: for custom domain or subdomain
  plan   String  @default("free") // free, pro, enterprise

  // Workspace discovery and joining
  slug            String  @unique // URL friendly identifier: codeb-team
  inviteCode      String  @unique // Short invite code: ABC123
  isPublic        Boolean @default(false) // Public workspaces appear in search
  requireApproval Boolean @default(true) // Require admin approval for join requests

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members       WorkspaceMember[]
  projects      Project[]
  attendances   Attendance[]
  approvals     ApprovalDocument[]
  contracts     Contract[]
  transactions  Transaction[]
  announcements Announcement[]
  teams         Team[]
  workPolicy    WorkPolicy?
  invitations   Invitation[]
  joinRequests  JoinRequest[]
  boards        Board[]
  events        CalendarEvent[]
}

model WorkspaceMember {
  id          String @id @default(uuid())
  workspaceId String
  userId      String
  role        Role   @default(member) // admin, member (using existing Role enum)

  joinedAt DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
}

model User {
  id          String    @id @default(uuid())
  email       String    @unique
  name        String
  role        Role      @default(member) // Kept for backward compatibility during migration
  department  String? // Planning/Development/Design/Operations/Marketing
  avatar      String?
  phoneNumber String?
  companyName String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLogin   DateTime?

  // Relations
  workspaces      WorkspaceMember[]
  projects        ProjectMember[]
  createdProjects Project[]         @relation("CreatedProjects")
  assignedTasks   Task[]            @relation("AssignedTasks")
  createdTasks    Task[]            @relation("CreatedTasks")
  comments        TaskComment[]
  activities      Activity[]

  // HR & Finance relations
  attendances      Attendance[]
  approvalRequests ApprovalDocument[] @relation("ApprovalRequester")
  approvalSteps    ApprovalStep[]     @relation("ApprovalApprover")
  transactions     Transaction[]      @relation("TransactionCreator")
  announcements    Announcement[]     @relation("AnnouncementAuthor")

  // Team relations
  teamMemberships   TeamMember[]
  presenceCheckLogs PresenceCheckLog[]

  // Invitation and join request relations
  sentInvitations  Invitation[]  @relation("InvitedBy")
  joinRequests     JoinRequest[] @relation("JoinRequester")
  reviewedRequests JoinRequest[] @relation("ReviewedBy")

  // Board and Calendar relations
  boardPosts       Board[]                 @relation("BoardAuthor")
  boardComments    BoardComment[]          @relation("BoardCommentAuthor")
  createdEvents    CalendarEvent[]         @relation("EventCreator")
  eventAttendances CalendarEventAttendee[] @relation("EventAttendee")
}

model Project {
  id          String            @id @default(uuid())
  workspaceId String? // Optional for migration, should be required later
  name        String
  description String?
  clientId    String?
  clientName  String?
  status      ProjectStatus     @default(planning)
  progress    Int               @default(0)
  startDate   DateTime?
  endDate     DateTime?
  budget      Float?
  visibility  ProjectVisibility @default(private)
  priority    ProjectPriority   @default(medium)
  tags        String[]

  createdBy String
  creator   User   @relation("CreatedProjects", fields: [createdBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Relations
  members      ProjectMember[]
  tasks        Task[]
  files        File[]
  activities   Activity[]
  aiMetrics    AIMetrics?
  contracts    Contract[]
  transactions Transaction[]
}

model ProjectMember {
  id        String   @id @default(uuid())
  projectId String
  userId    String
  role      String // PM, Developer, Designer etc.
  joinedAt  DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
}

// model Task {
//   id          String       @id @default(uuid())
//   projectId   String?
//   title       String
//   description String?
//   status      TaskStatus   @default(todo)
//   priority    TaskPriority @default(medium)
// 
//   startDate DateTime?
//   dueDate   DateTime?
// 
//   assigneeId String?
//   assignee   User?   @relation("AssignedTasks", fields: [assigneeId], references: [id])
// 
//   createdBy String
//   creator   User   @relation("CreatedTasks", fields: [createdBy], references: [id])
// 
//   labels String[]
// 
//   // Kanban specific
//   columnId String?
//   order    Int     @default(0)
// 
//   // Gantt specific
//   progress     Int      @default(0)
//   dependencies String[] // Array of Task IDs
// 
//   // Mindmap specific
//   mindmapNodeId String? // ID of the node in the mindmap
// 
//   createdAt DateTime @default(now())
//   updatedAt DateTime @updatedAt
// 
//   project Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
// 
//   // Relations
//   attachments TaskAttachment[]
//   checklist   ChecklistItem[]
//   comments    TaskComment[]
// }

model TaskAttachment {
  id         String   @id @default(uuid())
  taskId     String
  name       String
  url        String
  size       Int
  type       String
  uploadedBy String
  uploadedAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

model ChecklistItem {
  id        String  @id @default(uuid())
  taskId    String
  text      String
  completed Boolean @default(false)

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

model TaskComment {
  id        String   @id @default(uuid())
  taskId    String
  userId    String
  text      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model File {
  id         String   @id @default(uuid())
  projectId  String
  name       String
  size       Int
  type       String
  url        String
  uploadedBy String
  category   String   @default("other")
  createdAt  DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model AIMetrics {
  id        String @id @default(uuid())
  projectId String @unique

  quality      Int @default(0)
  budgetUsage  Int @default(0)
  efficiency   Int @default(0)
  satisfaction Int @default(0)

  predictions Json?
  risks       Json?

  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Activity {
  id        String   @id @default(uuid())
  projectId String
  type      String
  message   String
  userId    String
  userName  String
  icon      String
  timestamp DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================
// Phase 3: HR & Groupware Models
// ============================================

model Attendance {
  id          String           @id @default(uuid())
  userId      String
  workspaceId String?
  date        DateTime
  checkIn     DateTime?
  checkOut    DateTime?
  status      AttendanceStatus @default(PRESENT)
  note        String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([userId, date])
}

model ApprovalDocument {
  id          String         @id @default(uuid())
  workspaceId String?
  title       String
  content     String
  type        ApprovalType   @default(GENERAL)
  requesterId String
  status      ApprovalStatus @default(PENDING)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  workspace Workspace?     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  requester User           @relation("ApprovalRequester", fields: [requesterId], references: [id])
  approvals ApprovalStep[]
}

model ApprovalStep {
  id         String         @id @default(uuid())
  documentId String
  approverId String
  order      Int
  status     ApprovalStatus @default(PENDING)
  comment    String?
  approvedAt DateTime?
  createdAt  DateTime       @default(now())

  document ApprovalDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  approver User             @relation("ApprovalApprover", fields: [approverId], references: [id])

  @@index([documentId, order])
}

// ============================================
// Phase 4: Finance Models
// ============================================

model Contract {
  id          String         @id @default(uuid())
  workspaceId String?
  projectId   String?
  title       String
  clientName  String
  amount      Float
  startDate   DateTime
  endDate     DateTime
  status      ContractStatus @default(DRAFT)
  documents   String[] // File URLs
  description String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project   Project?   @relation(fields: [projectId], references: [id], onDelete: SetNull)
}

model Transaction {
  id          String          @id @default(uuid())
  workspaceId String?
  projectId   String?
  type        TransactionType
  category    String
  amount      Float
  date        DateTime
  description String
  createdBy   String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project   Project?   @relation(fields: [projectId], references: [id], onDelete: SetNull)
  creator   User       @relation("TransactionCreator", fields: [createdBy], references: [id])

  @@index([workspaceId, date])
  @@index([projectId, date])
}

// ============================================
// Phase 5: Groupware Models
// ============================================

model Announcement {
  id          String   @id @default(uuid())
  workspaceId String?
  title       String
  content     String
  authorId    String
  isPinned    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  author    User       @relation("AnnouncementAuthor", fields: [authorId], references: [id])

  @@index([workspaceId, isPinned, createdAt])
}

// ============================================
// Phase 6: Organization & Team Management
// ============================================

model Team {
  id          String   @id @default(uuid())
  workspaceId String
  name        String // Planning, Development, Design, Operations, Marketing
  color       String   @default("#3B82F6")
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  members   TeamMember[]

  @@index([workspaceId, order])
}

model TeamMember {
  id       String   @id @default(uuid())
  teamId   String
  userId   String
  role     String? // Team role (optional)
  joinedAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

enum WorkType {
  FIXED
  FLEXIBLE
  CORE_TIME
}

model WorkPolicy {
  id          String   @id @default(uuid())
  workspaceId String?  @unique
  type        WorkType @default(FIXED)

  dailyRequiredMinutes  Int  @default(480)
  weeklyRequiredMinutes Int?

  workStartTime String? @default("09:00")
  workEndTime   String? @default("18:00")

  coreTimeStart String? @default("11:00")
  coreTimeEnd   String? @default("16:00")

  allowRemoteCheckIn Boolean @default(true)

  autoClockOutEnabled          Boolean @default(true)
  autoClockOutTime             String? @default("19:30")
  missingClockOutPenaltyPoints Int     @default(5)

  presenceCheckEnabled          Boolean @default(true)
  presenceIntervalMinutes       Int     @default(90)
  presenceResponseWindowMinutes Int     @default(10)
  presenceMissPenaltyPoints     Int     @default(3)
  presenceCheckOnlyRemote       Boolean @default(true)

  officeIpWhitelist String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model PresenceCheckLog {
  id           String    @id @default(uuid())
  userId       String
  attendanceId String
  triggeredAt  DateTime  @default(now())
  respondedAt  DateTime?
  status       String    @default("pending")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, triggeredAt])
}

// ============================================
// User Invitation & Join Request Models
// ============================================

model Invitation {
  id          String           @id @default(uuid())
  workspaceId String
  email       String
  token       String           @unique
  role        Role             @default(member)
  invitedBy   String
  status      InvitationStatus @default(PENDING)
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  inviter   User      @relation("InvitedBy", fields: [invitedBy], references: [id])

  @@index([email])
  @@index([token])
  @@index([workspaceId])
  @@index([status])
}

model JoinRequest {
  id          String            @id @default(uuid())
  workspaceId String
  userId      String
  message     String?
  status      JoinRequestStatus @default(PENDING)
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNote  String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation("JoinRequester", fields: [userId], references: [id], onDelete: Cascade)
  reviewer  User?     @relation("ReviewedBy", fields: [reviewedBy], references: [id])

  @@unique([workspaceId, userId])
  @@index([userId])
  @@index([workspaceId, status])
}

// ============================================
// Phase 7: Groupware - Board & Calendar
// ============================================

model Board {
  id          String   @id @default(uuid())
  workspaceId String
  title       String
  content     String
  authorId    String
  category    String   @default("일반") // 일반, 공지, 질문, 자유
  viewCount   Int      @default(0)
  isPinned    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  author    User           @relation("BoardAuthor", fields: [authorId], references: [id])
  comments  BoardComment[]

  @@index([workspaceId, isPinned, createdAt])
  @@index([workspaceId, category])
}

model BoardComment {
  id        String   @id @default(uuid())
  boardId   String
  authorId  String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  board  Board @relation(fields: [boardId], references: [id], onDelete: Cascade)
  author User  @relation("BoardCommentAuthor", fields: [authorId], references: [id])

  @@index([boardId, createdAt])
}

model CalendarEvent {
  id          String   @id @default(uuid())
  workspaceId String
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime
  location    String?
  color       String   @default("#3B82F6")
  isAllDay    Boolean  @default(false)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace               @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  creator   User                    @relation("EventCreator", fields: [createdBy], references: [id])
  attendees CalendarEventAttendee[]

  @@index([workspaceId, startDate])
  @@index([workspaceId, endDate])
}

model CalendarEventAttendee {
  id      String @id @default(uuid())
  eventId String
  userId  String
  status  String @default("pending") // pending, accepted, declined

  event CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User          @relation("EventAttendee", fields: [userId], references: [id])

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}
